machine:
  pre:
    - sudo curl -L -o /usr/bin/docker 'https://s3-external-1.amazonaws.com/circle-downloads/docker-1.9.1-circleci'
    - sudo chmod 0755 /usr/bin/docker
    - sudo pip install --upgrade awscli
  environment:
    GOOROT: /home/ubuntu/.gimme/versions/go1.5.2.linux.amd64
  services:
    - docker
    - redis
    - postgresql
  node:
    version:
      5.1.0
dependencies:
  pre:
    - echo "" > ~/.gitconfig
  override:
    - ./bin/install_dependencies.sh
  cache_directories:
    - "/home/ubuntu/.go_workspace"
    - "/home/ubuntu/.gimme"
    - "/home/ubuntu/.dashboard_node_modules"
    - "/home/ubuntu/.website_node_modules"
database:
  override:
    - PGPASSWORD=unicode psql -U ubuntu -d circle_test -f v02/resources/db/pgsql.sql -h 127.0.0.1
test:
  pre:
    - mkdir -p /home/ubuntu/.go_workspace/src/github.com/tapglue
    - ln -nfs /home/ubuntu/multiverse /home/ubuntu/.go_workspace/src/github.com/tapglue/multiverse
    - ./bin/test_configs.sh intaker
  override:
    - ./bin/run_tests.sh object
    - ./bin/run_tests.sh redis
    - ./bin/run_tests.sh intaker postgres
    - ./bin/run_tests.sh intaker redis
    - ./infrastructure/containers/docker/test.sh object
    - ./infrastructure/containers/docker/test.sh redis
    - ./infrastructure/containers/docker/test.sh intaker postgres
    - ./infrastructure/containers/docker/test.sh intaker redis
  post:
    - ./bin/process_coverage.sh
deployment:
  s3:
    branch: /.*/
    commands:
      - ./bin/make_release.sh intaker redis
      - ./bin/make_release.sh intaker postgres
      - ./bin/make_release.sh corporate dashboard
      - ./bin/make_release.sh corporate styleguide
      - ./bin/make_release.sh corporate website
      - ./infrastructure/containers/docker/release_container.sh intaker docker_intaker_redis_${CIRCLE_BUILD_NUM} ./infrastructure/config/intaker_prod.json 
      - ./infrastructure/containers/docker/release_container.sh corporate 
