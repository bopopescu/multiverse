machine:
  services:
    - docker
    - redis
    - postgresql
dependencies:
  pre:
    - echo "" > ~/.gitconfig
  override:
    - docker run -d -t -p 4567:4567 dlsniper/kinesalite:1.8.0
    - sudo chown -R ubuntu /home/ubuntu/.cache/
    - sudo -H pip install awscli
    - sudo chown -R ubuntu /home/ubuntu/.cache/
    - sudo curl -sL -o /usr/local/bin/gimme https://raw.githubusercontent.com/travis-ci/gimme/master/gimme
    - sudo chmod +x /usr/local/bin/gimme
    - eval "$(GIMME_GO_VERSION=1.4.2 gimme)"
    - /home/ubuntu/.gimme/versions/go1.4.2.linux.amd64/bin/go get github.com/tools/godep github.com/axw/gocov/gocov github.com/matm/gocov-html gopkg.in/check.v1
  cache_directories:
    - "~/.go_workspace"
database:
  override:
    - PGPASSWORD=unicode psql -U ubuntu -d circle_test -f v02/resources/db/pgsql.sql -h 127.0.0.1
test:
  pre:
    - mkdir -p /home/ubuntu/.go_workspace/src/github.com/tapglue
    - ln -nfs /home/ubuntu/backend /home/ubuntu/.go_workspace/src/github.com/tapglue/backend
    - ./bin/test_configs.sh intaker
  override:
    - ./bin/run_tests.sh intaker postgres
    - ./bin/run_tests.sh intaker kinesis
    - ./bin/run_tests.sh distributor postgres
  post:
    - ./bin/process_coverage.sh
deployment:
  s3:
    branch: master
    commands:
      - ./bin/make_release.sh intaker postgres
      - ./bin/make_release.sh intaker kinesis
      - ./bin/make_release.sh distributor postgres
