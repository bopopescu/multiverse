machine:
  services:
    - docker
    - redis
    - postgresql
dependencies:
  pre:
    - echo "" > ~/.gitconfig
  override:
    - docker run -d -t -p 4567:4567 dlsniper/kinesalite:1.7.0
    - sudo pip install codecov awscli
    - sudo chown -R ubuntu /home/ubuntu/.cache/
    - go get github.com/tools/godep github.com/axw/gocov/gocov github.com/AlekSi/gocov-xml gopkg.in/check.v1
  cache_directories:
    - "~/.go_workspace"
database:
  override:
    - PGPASSWORD=unicode psql -U ubuntu -d circle_test -f v02/resources/db/pgsql.sql -h 127.0.0.1
test:
  pre:
    - mkdir -p /home/ubuntu/.go_workspace/src/github.com/tapglue
    - ln -nfs /home/ubuntu/backend /home/ubuntu/.go_workspace/src/github.com/tapglue/backend
    - ./bin/test_configs.sh intaker
  override:
    - ./bin/run_tests.sh postgres
    - ./bin/run_tests.sh kinesis
  post:
    - ./bin/process_coverage.sh
    - rm -f /home/ubuntu/.go_workspace/src/github.com/tapglue/backend
deployment:
  s3:
    branch: master
    commands:
      - ./bin/make_release.sh postgres
      - ./bin/make_release.sh kinesis
