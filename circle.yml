machine:
  node:
    version: 0.10.26
  services:
    - docker
    - redis
dependencies:
  pre:
    - echo "" > ~/.gitconfig
    - docker run -d -t -p 4567:4567 dlsniper/kinesalite:1.4.1
    - sudo pip install codecov
    - go get -v -u github.com/tools/godep
    - go get -v -u github.com/axw/gocov/gocov
    - go get -v -u github.com/AlekSi/gocov-xml
    - ./bin/test_configs.sh
test:
  override:
    - cd v01/server && GOPATH=`godep path`:$GOPATH gocov test -race -coverpkg=github.com/tapglue/backend/v01/server,github.com/tapglue/backend/v01/core,github.com/tapglue/backend/v01/context,github.com/tapglue/backend/v01/storage,github.com/tapglue/backend/v01/storage/redis,github.com/tapglue/backend/v01/validator,github.com/tapglue/backend/v01/validator/keys,github.com/tapglue/backend/v01/validator/tokens,github.com/tapglue/backend/v01/fixtures,github.com/tapglue/backend/v01/entity -check.v | GOPATH=`godep path`:$GOPATH gocov-xml > coverage.xml
    - cd v02/server && GOPATH=`godep path`:$GOPATH gocov test -race -coverpkg=github.com/tapglue/backend/v02/server,github.com/tapglue/backend/v02/core,github.com/tapglue/backend/v02/context,github.com/tapglue/backend/v02/storage,github.com/tapglue/backend/v02/storage/redis,github.com/tapglue/backend/v02/validator,github.com/tapglue/backend/v02/validator/keys,github.com/tapglue/backend/v02/validator/tokens,github.com/tapglue/backend/v02/fixtures,github.com/tapglue/backend/v02/entity -check.v | GOPATH=`godep path`:$GOPATH gocov-xml > coverage.xml
  post:
    - cd v01/server && codecov --token=$CODECOV_TOKEN
    - cd v02/server && codecov --token=$CODECOV_TOKEN
