box: wercker/golang@1.3.0
services:
  - wercker/mysql
  - dlsniper/aerospike
build:
  steps:
    - setup-go-workspace
    - script:
        name: initializing go dependencies
        code: |-
          cd $WERCKER_SOURCE_DIR
          $WERCKER_SOURCE_DIR/bin/godeps.sh
    - script:
        name: deploying test config
        code: |-
          export WERCKER_SOURCE_DIR=${GOPATH}/src/github.com/tapglue/backend
          cd $WERCKER_SOURCE_DIR
          $WERCKER_SOURCE_DIR/bin/test_configs.sh
    - script:
        name: setup mysql database
        code: |-
          export WERCKER_SOURCE_DIR=${GOPATH}/src/github.com/tapglue/backend
          cd $WERCKER_SOURCE_DIR
          $WERCKER_SOURCE_DIR/bin/deploy_db.sh
    - script:
        name: test building project
        code: |-
          export WERCKER_SOURCE_DIR=${GOPATH}/src/github.com/tapglue/backend
          cd $WERCKER_SOURCE_DIR
          go build -o tapglue-backend backend.go
          rm -f tapglue-backend
    - script:
        name: test database
        code: |-
          export WERCKER_SOURCE_DIR=${GOPATH}/src/github.com/tapglue/backend
          cd $WERCKER_SOURCE_DIR/db
          go test --race -check.v
    - script:
        name: test server
        code: |-
          export WERCKER_SOURCE_DIR=${GOPATH}/src/github.com/tapglue/backend
          cd $WERCKER_SOURCE_DIR/server
          go test --race -check.v
  after-steps:
        - sherzberg/slack-notify:
            subdomain: tapglue
            token: $SLACK_TOKEN
            channel: "#development"
            username: wercker
            icon_url: https://avatars3.githubusercontent.com/u/1695193?s=140
