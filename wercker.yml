box: wercker/golang@1.3.2
services:
  - wercker/redis@1.0.1
build:
  steps:
    - setup-go-workspace
    - script:
        name: initializing go dependencies
        code: |-
          go get -v -u github.com/tools/godep
    - script:
        name: getting code coverage tool
        code: |-
          sudo pip install codecov
          go get github.com/axw/gocov/gocov/...
          go get github.com/AlekSi/gocov-xml
    - script:
        name: deploying test config
        code: |-
          export WERCKER_SOURCE_DIR=${GOPATH}/src/github.com/tapglue/backend
          cd $WERCKER_SOURCE_DIR
          $WERCKER_SOURCE_DIR/bin/test_configs.sh
    - script:
        name: test building project
        code: |-
          export WERCKER_SOURCE_DIR=${GOPATH}/src/github.com/tapglue/backend
          cd $WERCKER_SOURCE_DIR
          godep go build -o tapglue-backend backend.go
          cp tapglue-backend ${WERCKER_OUTPUT_DIR}/
#    - script:
#        name: test core
#        code: |-
#          export WERCKER_SOURCE_DIR=${GOPATH}/src/github.com/tapglue/backend
#          cd $WERCKER_SOURCE_DIR/core
#          go test -race -check.v
    - script:
        name: test server v1
        code: |-
          export WERCKER_SOURCE_DIR=${GOPATH}/src/github.com/tapglue/backend
          cd $WERCKER_SOURCE_DIR/v1/server
          GOPATH=`godep path`:$GOPATH gocov test -race -check.v | GOPATH=`godep path`:$GOPATH gocov-xml > coverage.xml
    - script:
        name: codecov server v1
        code: |-
          export WERCKER_SOURCE_DIR=${GOPATH}/src/github.com/tapglue/backend
          cd $WERCKER_SOURCE_DIR/v1/server
          codecov --token=209a849f-0c0a-4f7a-b336-d9fb47d31afc
#    - script:
#        name: bechmark core
#        code: |-
#          export WERCKER_SOURCE_DIR=${GOPATH}/src/github.com/tapglue/backend
#          cd $WERCKER_SOURCE_DIR/core
#          go test -check.b
  after-steps:
        - sherzberg/slack-notify:
            subdomain: tapglue
            token: $SLACK_TOKEN
            channel: "#development"
            username: wercker
            icon_url: https://avatars3.githubusercontent.com/u/1695193?s=140
