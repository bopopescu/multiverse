box: wercker/golang@1.3.1
services:
  - wercker/redis@1.0.1
build:
  steps:
    - setup-go-workspace
    - script:
        name: initializing go dependencies
        code: |-
          cd $WERCKER_SOURCE_DIR
          $WERCKER_SOURCE_DIR/bin/godeps.sh
    - script:
        name: getting code coverage tool
        code: |-
          sudo pip install codecov
          go get github.com/axw/gocov/gocov/...
          go get github.com/AlekSi/gocov-xml
    - script:
        name: deploying test config
        code: |-
          export WERCKER_SOURCE_DIR=${GOPATH}/src/github.com/tapglue/backend
          cd $WERCKER_SOURCE_DIR
          $WERCKER_SOURCE_DIR/bin/test_configs.sh
    - script:
        name: test building project
        code: |-
          export WERCKER_SOURCE_DIR=${GOPATH}/src/github.com/tapglue/backend
          cd $WERCKER_SOURCE_DIR
          go build -o tapglue-backend backend.go
          rm -f tapglue-backend
#    - script:
#        name: test core
#        code: |-
#          export WERCKER_SOURCE_DIR=${GOPATH}/src/github.com/tapglue/backend
#          cd $WERCKER_SOURCE_DIR/core
#          go test -race -check.v
    - script:
        name: test server
        code: |-
          export WERCKER_SOURCE_DIR=${GOPATH}/src/github.com/tapglue/backend
          cd $WERCKER_SOURCE_DIR/server
          gocov test -race -check.v | gocov-xml > coverage.xml
    - script:
        name: codecov
        code: |-
          export WERCKER_SOURCE_DIR=${GOPATH}/src/github.com/tapglue/backend
          cd $WERCKER_SOURCE_DIR/server
          codecov --token=209a849f-0c0a-4f7a-b336-d9fb47d31afc
#    - script:
#        name: bechmark core
#        code: |-
#          export WERCKER_SOURCE_DIR=${GOPATH}/src/github.com/tapglue/backend
#          cd $WERCKER_SOURCE_DIR/core
#          go test -check.b
  after-steps:
        - sherzberg/slack-notify:
            subdomain: tapglue
            token: $SLACK_TOKEN
            channel: "#development"
            username: wercker
            icon_url: https://avatars3.githubusercontent.com/u/1695193?s=140
